---
title: "Introduction"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
is_check <- ("CheckExEnv" %in% search()) || any(c("_R_CHECK_TIMINGS_",
             "_R_CHECK_LICENSE_") %in% names(Sys.getenv()))
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = !is_check,
  purl = !is_check
)
```

```{r setup}
library(ppjsdm)

remove(list = ls())

set.seed(1)
```

# Working with the Queensland trees dataset

This package contains the locations of treets twenty plots located in Queensland, Australia.
The data is accessed as follows.

```{r}
index_of_plot <- 3 # Between 1 and 20
year <- 2011 # Year of census
number_of_species <- 2 # Includes the most prevalent species from the plot

configuration <- ppjsdm::get_qld_trees_configuration(index = index_of_plot, 
                                                     year = year, 
                                                     prevalent = number_of_species)
```

Our point process class only includes the locations of the trees, so we also need to provide information about the observation window.
All plots are of size $100\mathrm{m}\times50\mathrm{m}$, so we define the window as follows.

```{r}
window <- ppjsdm::Rectangle_window(c(0, 100), c(0, 50))
```

```{r, fig.height = 4, fig.align = 'center', fig}
par(mar = c(5, 4, 4, 13) + 0.1)
plot(configuration, window = window)
```

The function `gibbsm` fits a multivariate Gibbs point process to our dataset.
For example,

```{r}
fit <- ppjsdm::gibbsm(configuration, window = window)
```

By default, the function fits the model that was introduced in the ARC grant [TODO: Add reference].
This model has many drawbacks, the most important of which is that the model with the fitted values is degenerate, as can be seen by drawing from the model.

```{r}
lambda <- exp(fit$coefficients[1:number_of_species])
alpha <- matrix(c(fit$coefficients[3], 
                  fit$coefficients[4], 
                  fit$coefficients[4], 
                  fit$coefficients[5]), ncol = number_of_species, nrow = number_of_species)
draw <- ppjsdm::rmultigibbs(window = window, 
                            alpha = alpha, 
                            lambda = lambda, 
                            types = levels(types(configuration)))
```

```{r}
par(mar = c(5, 4, 4, 13) + 0.1)
plot(draw, window = window)
```

The Geyer model is better suited to most situations, but the user needs to specify some additional parameters before the fitting may take place.

```{r}
radii <- matrix(5, number_of_species, number_of_species)
```

The matrix `radii` models interaction radii within a species, and between species.
An interaction radius of $5$ gives good results in the fitting procedure.

```{r}
fit <- ppjsdm::gibbsm(configuration, window = window, model = "Geyer", radius = radii)
```

Note that we do not have the previous problem here.

```{r}
lambda <- exp(fit$coefficients[1:number_of_species])
alpha <- matrix(c(fit$coefficients[3], 
                  fit$coefficients[4], 
                  fit$coefficients[4], 
                  fit$coefficients[5]), ncol = number_of_species, nrow = number_of_species)
draw <- ppjsdm::rmultigibbs(window = window, 
                            alpha = alpha, 
                            lambda = lambda,
                            model = "Geyer", 
                            radius = radii,
                            types = levels(types(configuration)))
```

```{r}
par(mar = c(5, 4, 4, 13) + 0.1)
plot(draw, window = window)
```

# Using covariates

This section assumes you have a series of covariates explaining a given dataset. 
To illustrate how the package works, we define arbitrarily the following covariates.

```{r}
temperature <- function(x, y) 1 - 4 * (x - 0.5)^2
wetness <- function(x, y) 0.5 * (1 + sin(pi * 2 * (y - 1)))

covariates <- list(temperature = temperature, wetness = wetness)
```

Finally, we need a dataset to work on.

```{r}
configuration <- ppjsdm::rppp(lambda = c(50, 50))
```

The function `gibbsm` fits a multivariate Gibbs point process to our dataset.
For example,

```{r}
ppjsdm::gibbsm(configuration, covariates = covariates)
```

# Using traits

This section assumes you have a series of traits explaining a given dataset. 
To illustrate how the package works, we define arbitrarily the following trait.

```{r}
average_height <- list(type1 = 50, type2 = 70, type3 = 60)
average_seed_size <- list(type1 = 30, type2 = 15, type3 = 20)

traits <- list(average_height = average_height, average_seed_size = average_seed_size)
```

Finally, we need a dataset to work on.

```{r}
configurations <- append(ppjsdm::rppp(lambda = c(50, 50), nsim = 1, types = c("type1", "type2"), drop = FALSE),
                         ppjsdm::rppp(lambda = c(50, 50), nsim = 1, types = c("type2", "type3"), drop = FALSE))
```

The function `gibbsm` fits a multivariate Gibbs point process to our dataset.
For example,

```{r}
ppjsdm::gibbsm(configurations, traits = traits)
```

# Using traits on Queensland data

There is also a function to extract the average species height from the Queesland data.

```{r}
# index_of_plot <- 3 # Between 1 and 20
# year <- 2011 # Year of census
# number_of_species <- 3 # Includes the most prevalent species from the plot
# 
# ret <- ppjsdm::get_qld_trees_configuration(index = index_of_plot, 
#                                           year = year, 
#                                           prevalent = number_of_species,
#                                           average_height = TRUE,
#                                           average_dbh = TRUE)
# 
# configuration <- ret$configuration
# traits <- list(average_height = ret$average_height, average_dbh = ret$average_dbh)
# window <- ppjsdm::Rectangle_window(c(0, 100), c(0, 50))
# radii <- matrix(5, number_of_species, number_of_species)
```

We may then fit our model to this dataset.

```{r}
# fit <- ppjsdm::gibbsm(configuration, 
#                       window = window, 
#                       model = "Geyer", 
#                       radius = radii, 
#                       traits = traits)
```
