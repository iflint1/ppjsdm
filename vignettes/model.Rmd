---
title: "Details on the model and how it can be customised"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
is_check <- ("CheckExEnv" %in% search()) || any(c("_R_CHECK_TIMINGS_",
             "_R_CHECK_LICENSE_") %in% names(Sys.getenv()))
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = !is_check,
  purl = !is_check
)
```

```{r setup}
library(ppjsdm)
library(spatstat)

remove(list = ls())

set.seed(1)
```

In this vignette, we give some details on the model we are using.

We begin by introducing the Papangelou conditional intensity.
For a point configuration $\omega$, a location in space $x$, and a species index $i$, the Papangelou conditional intensity $\pi$ is such that $\pi((x,i),\omega)\cdot\Delta x$ is the probability of finding an individual of species $i$ in the infinitesimal volume $\Delta x$ around $x$, conditional on $\omega$ outside of $\Delta x$.
The package includes a function to compute the Papangelou conditional intensity of the model we are simulating from.

In the rest of this vignette, we illustrate this concept with a some examples.

# No interaction: Poisson point process

We begin by considering a single species, with no repulsion, no covariates, and a given intensity.

```{r}
nspecies <- 1
lambda <- 50
alpha <- matrix(0)
beta <- matrix(0)
covariates <- list()
model <- "Geyer"
radius <- matrix(0.1, nspecies, nspecies)
saturation <- 2
window <- Rectangle_window()
spatstat_window <- owin()
```

Take a single sample from the corresponding point process,

```{r}
configuration <- rgibbs(window = window, 
                        alpha = alpha, 
                        lambda = lambda, 
                        beta = beta, 
                        covariates = covariates,
                        model = model)
```

and plot it below.

```{r, fig.height = 4, fig.align = 'center', fig}
par(mar = c(5, 4, 4, 13) + 0.1)
plot(configuration)
```

Now, we can compute the Papangelou conditional intensity over the region.

```{r}
x_axis <- seq(from = 0, to = 1, by = 0.001)
y_axis <- x_axis
z <- outer(x_axis, y_axis, function(x, y) {
  compute_papangelou(configuration, x, y, 1, model, alpha, 
                     lambda, beta, covariates, radius, saturation)
})
```

In this case, the Papangelou conditional intensity is equal to the intensity over the whole region:

```{r}
all(z == lambda)
```

This means that the probability of finding a point anywhere on the region conditional on the given locations is independent of the locations, and proportional to the intensity everywhere.
In other words, the associated point process is a Poisson point process of intensity `lambda`.

# Adding interactions

We now add interactions between individuals, as controlled by the parameter `alpha`.

```{r}
alpha <- matrix(-1)
```

Let us see how this changes the Papangelou conditional intensity.
Writing a quick function to plot the configuration and the Papangelou conditional intensity will be useful.
(Note: we use the plotting facilities from `spatstat` here and in the remainder of the vignette.)

```{r}
plot_pap <- function(configuration, type, model, alpha, 
                     lambda, beta, covariates, radius, saturation) {
  x_axis <- seq(from = 0, to = 1, by = 0.001)
  y_axis <- x_axis
  z <- outer(x_axis, y_axis, function(x, y) {
    compute_papangelou(configuration, x, y, type, model, alpha, 
                      lambda, beta, covariates, radius, saturation)
  })
  par(mar = c(5, 4, 4, 13) + 0.1)
  plot(as.im(t(z), W = spatstat_window))
  plot(as.ppp(configuration, spatstat_window), add = TRUE)
}
```

We can then plot the Papangelou conditional intensity by a call to that function.

```{r}
plot_pap(configuration, 1, model, alpha, lambda, beta, covariates, radius, saturation) 
```

The plot indicates repulsion within a given interaction radius: at locations far from existing individuals in the configuration, the Papangelou conditional intensity is equal to `lambda`, and it decreases within the interaction radius.
The parameter `alpha` controls the strength of the repulsion, and when it is increased (in absolute value) the point process becomes more repulsive.

```{r}
alpha <- matrix(-4)
plot_pap(configuration, 1, model, alpha, lambda, beta, covariates, radius, saturation)
```

Making `alpha` positive instead of negative changes the behaviour.

```{r}
alpha <- matrix(1)
plot_pap(configuration, 1, model, alpha, lambda, beta, covariates, radius, saturation)
```

The Papangelou conditional intensity is now larger at locations closer to existing individuals, indicating that the point process is attractive.
Thus, our model is either attractive or repulsive depending on the sign of `alpha`.

# Changing features of the interaction

It is also possible to change different features of the interaction.
To begin with, you can control the radius of interaction.

```{r}
alpha <- matrix(-1)
radius <- matrix(0.05, nspecies, nspecies)
plot_pap(configuration, 1, model, alpha, lambda, beta, covariates, radius, saturation)
```

It is also possible to change the number of closest individuals that are taken into account, via the `saturation` parameter.
For example, let us account for the five closest individuals instead of the two closest.

```{r}
radius <- matrix(0.1, nspecies, nspecies)
saturation <- 5
plot_pap(configuration, 1, model, alpha, lambda, beta, covariates, radius, saturation)
```

There are also various kinds of smoothing available via the `model` parameter.
Here is what the exponential smoothing looks like.

```{r}
saturation <- 2
model <- "exponential"
plot_pap(configuration, 1, model, alpha, lambda, beta, covariates, radius, saturation)
```

And as another example, here is what the `square_bump` smoothing is like.

```{r}
model <- "square_bump"
plot_pap(configuration, 1, model, alpha, lambda, beta, covariates, radius, saturation)
```

# Discussion of the different variations

These different variations of the model generate quite different samples in extreme cases.
For example, for a very large value of the repulsion parameter, the Geyer model exhibits extreme regularity.

```{r}
extreme_configuration <- rgibbs(window = window, 
                                alpha = matrix(-10), 
                                lambda = 5000, 
                                model = "Geyer",
                                steps = 1000000,
                                radius = radius)
par(mar = c(5, 4, 4, 13) + 0.1)
plot(extreme_configuration)
```

Other variants of the model show other interesting features.
As an illustration, here is a plot of an extremely attractive square exponential version of the model.

```{r}
extreme_configuration <- rgibbs(window = window, 
                                alpha = matrix(9), 
                                lambda = 0.1, 
                                model = "square_exponential",
                                steps = 1000000,
                                radius = radius)
par(mar = c(5, 4, 4, 13) + 0.1)
plot(extreme_configuration)
```

# Adding covariates

Adding covariates is also possible.
It is best to provide the covariates as `spatstat::im` objects, and it is usually easy to convert to that format thanks to the conversion functions provided by `spatstat`.

```{r}
model <- "Geyer"
covariates <- list(temperature = as.im(function(x, y) x, W = spatstat_window))
beta <- matrix(1)
plot_pap(configuration, 1, model, alpha, lambda, beta, covariates, radius, saturation)
```

# Multiple species setting

The package also works with multiple species.

```{r}
nspecies <- 2
lambda <- c(30, 30)
alpha <- cbind(c(-1, 0.5), c(0.5, -0.5))
beta <- matrix(0)
covariates <- list()
model <- "Geyer"
radius <- matrix(0.1, nspecies, nspecies)
saturation <- 2
window <- Rectangle_window()
spatstat_window <- owin()
```

We begin by plotting a sample from this distribution.

```{r}
configuration <- rgibbs(window = window, 
                        alpha = alpha, 
                        lambda = lambda, 
                        beta = beta, 
                        covariates = covariates)
```

```{r}
par(mar = c(5, 4, 4, 13) + 0.1)
plot(configuration)
```

And proceed to compute the corresponding Papangelou conditional intensity for an individual of the first species.

```{r}
plot_pap(configuration, 1, model, alpha, lambda, beta, covariates, radius, saturation)
```

It can be seen that the new individual exhibits repulsion from individuals of its own species (the circles) and is instead attracted to individuals of the other species (the triangles).
